From 01d637c852c3add100dbf4e451b8b30f0e891a73 Mon Sep 17 00:00:00 2001
From: Samuel Hym <samuel.hym@rustyne.lautre.net>
Date: Fri, 23 Feb 2024 12:00:32 +0100
Subject: [PATCH 06/14] WIP Use the STRIP command automatically detected by
 libtool

libtool configuration will try and detect the `strip` for the code
generated by the configured C compiler, so that it works also for a
cross-compiler

WIP: ensure it works also on MSVC, hopefully libtool-detected strip will
not break the compiled code
---
 Makefile.config.in |   1 +
 configure          | Bin 682390 -> 682391 bytes
 configure.ac       |   1 +
 stdlib/Makefile    |   5 +----
 4 files changed, 3 insertions(+), 4 deletions(-)

diff --git a/Makefile.config.in b/Makefile.config.in
index 4243bebad9..b91634efb6 100644
--- a/Makefile.config.in
+++ b/Makefile.config.in
@@ -185,6 +185,7 @@ OCAMLOPT_CFLAGS=@ocamlc_cflags@
 OCAMLOPT_CPPFLAGS=@ocamlc_cppflags@
 NATIVECCLIBS=@cclibs@
 SYSTHREAD_SUPPORT=@systhread_support@
+STRIP=@STRIP@
 PACKLD=@PACKLD@$(EMPTY)
 CCOMPTYPE=@ccomptype@
 TOOLCHAIN=@toolchain@
diff --git a/configure b/configure
index 810cf9fffb8510edb4ef95edd683a132ca023f95..be57107b0943619f28c4826a2a067c8a49605c3f 100755
GIT binary patch
delta 73
zcmbPsS#$bj%?(xln;ZOBGqMGT1bGH<O`k8%Dbeg4xZOFBQAoW#q=FHMnShuXh*^M`
T6^Pk@m>q~Ywue-3I(-BH;tU!5

delta 72
zcmbP!S##QD%?(xltid5co&lRH{ns!~Um(vZ(d-<!-8qm^NWDF*f)R+BfS4JGS%8=o
Sh}nRc9f&!$hgEPoegpv0mKps3

diff --git a/configure.ac b/configure.ac
index 6d4025dc55..342db956bc 100644
--- a/configure.ac
+++ b/configure.ac
@@ -243,6 +243,7 @@ AC_SUBST([mkdll_ldflags_exp])
 AC_SUBST([mkexe_ldflags_exp])
 AC_SUBST([PACKLD])
 AC_SUBST([build_libraries_manpages])
+AC_SUBST([STRIP])
 AC_SUBST([compute_deps])
 AC_SUBST([ocaml_bindir])
 AC_SUBST([ocaml_libdir])
diff --git a/stdlib/Makefile b/stdlib/Makefile
index 50f825a1b3..a7f2e60a7a 100644
--- a/stdlib/Makefile
+++ b/stdlib/Makefile
@@ -96,10 +96,7 @@ endif
 .INTERMEDIATE: tmpheader.exe
 tmpheader.exe: $(HEADERPROGRAM).$(O)
 	$(V_MKEXE)$(call MKEXE_VIA_CC,$@,$^)
-# FIXME This is wrong - mingw could invoke strip; MSVC equivalent?
-ifneq "$(UNIX_OR_WIN32)" "win32"
-	strip $@
-endif
+	$(STRIP) $@
 
 stdlib.cma: $(OBJS)
 	$(V_LINKC)$(CAMLC) -a -o $@ $^
-- 
2.43.0

