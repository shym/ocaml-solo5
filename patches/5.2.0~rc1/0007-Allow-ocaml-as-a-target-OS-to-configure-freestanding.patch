From d2ee69baecf8091676aa7308aaba7c42e685848b Mon Sep 17 00:00:00 2001
From: Samuel Hym <samuel.hym@rustyne.lautre.net>
Date: Mon, 26 Feb 2024 11:51:11 +0100
Subject: [PATCH 07/14] Allow `ocaml` as a target OS to configure freestanding
 cross-compilers

Allow the use of *-*-ocaml or *-*-*-ocaml target triplets to stand for
freestanding cross-compilers by temporarily rewriting the target OS to
`none` when generating the canonical target

This allows to use *-*-ocaml and *-*-*-ocaml prefixes for cross-compiler
specific toolchains, so that all the specific tools (for instance
aarch64-solo5-ocaml-gcc, etc.) are automatically discovered
---
 configure    | Bin 682391 -> 682900 bytes
 configure.ac |  17 +++++++++++++++++
 2 files changed, 17 insertions(+)

diff --git a/configure b/configure
index be57107b0943619f28c4826a2a067c8a49605c3f..191e9976b8f2d1fa918442bae9c901412fd35d8a 100755
GIT binary patch
delta 551
zcmb7Au}T9$5G9%zz1GrZ+&hR7&O$pw3K4`<BKd%0Tqkj1a~pOSV;WCHOp#W|2jmxo
ze29gWKOugAlT-Af2+H!7nK#3mH#2#x-#^u_A4)HGSqKMOn*j(Tv8M%~1CO>#9**14
zF%~+O$azf9RN4h;dVQtI!s!q^_4>x5ReA`P23C3Q2tx4ZRFLonL~2qJz)_b{vgo<a
zJrbGEltlf}9#}%1yiZS1D|Af}6;lyNbOZ|=s1(Aj0AM?wzkG{2>@xv?GI4l8N$aTH
zjQGpRc~XmOdF&|jaJeX$7m8Ea#BLnz#rYPW5>Y`M8jUXx|8sEY_|kuJ@ca15$yIe@
qvVK$9nZc-ZTi*QU{>NFxXgV%2mKe*7GNZy+VN@Bbv*~#4_4y4rj<nnW

delta 60
zcmbPoU32<n&4w+EpW3EJH8YxTXX#|DW@%s8%Lv3wK+FupAU-P)vjH(X5OZu_*vt9(
FE&wE18qWX#

diff --git a/configure.ac b/configure.ac
index 342db956bc..4701a6afc1 100644
--- a/configure.ac
+++ b/configure.ac
@@ -287,7 +287,24 @@ AC_CONFIG_COMMANDS_PRE(OCAML_QUOTED_STRING_ID)
 
 AC_CANONICAL_BUILD
 AC_CANONICAL_HOST
+# Allow "ocaml" as target OS for freestanding compiler by temporarily rewriting
+# the target OS to "none" to generate the canonical target
+real_target_alias="$target_alias"
+AS_CASE([$target_alias],
+  [*-*-*-ocaml],
+    [ac_save_IFS=$IFS
+    IFS='-'
+    set x $target_alias
+    target_alias="$2-$3-none"
+    IFS=$ac_save_IFS],
+  [*-*-ocaml],
+    [ac_save_IFS=$IFS
+    IFS='-'
+    set x $target_alias
+    target_alias="$2-none"
+    IFS=$ac_save_IFS])
 AC_CANONICAL_TARGET
+target_alias="$real_target_alias"
 
 # Override cross_compiling and ac_tool_prefix variables since the C toolchain is
 # used to generate target code when building a cross compiler
-- 
2.43.0

