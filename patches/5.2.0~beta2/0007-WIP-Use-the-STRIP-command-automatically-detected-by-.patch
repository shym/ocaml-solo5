From 1e10b8a83db726a419f13bd8d1aba6f60e3abc4a Mon Sep 17 00:00:00 2001
From: Samuel Hym <samuel.hym@rustyne.lautre.net>
Date: Fri, 23 Feb 2024 12:00:32 +0100
Subject: [PATCH 07/14] WIP Use the STRIP command automatically detected by
 libtool

libtool configuration will try and detect the `strip` for the code
generated by the configured C compiler, so that it works also for a
cross-compiler

WIP: ensure it works also on MSVC, hopefully libtool-detected strip will
not break the compiled code
---
 Makefile.config.in |   1 +
 configure          | Bin 682374 -> 682375 bytes
 configure.ac       |   1 +
 stdlib/Makefile    |   5 +----
 4 files changed, 3 insertions(+), 4 deletions(-)

diff --git a/Makefile.config.in b/Makefile.config.in
index 4243bebad9..b91634efb6 100644
--- a/Makefile.config.in
+++ b/Makefile.config.in
@@ -185,6 +185,7 @@ OCAMLOPT_CFLAGS=@ocamlc_cflags@
 OCAMLOPT_CPPFLAGS=@ocamlc_cppflags@
 NATIVECCLIBS=@cclibs@
 SYSTHREAD_SUPPORT=@systhread_support@
+STRIP=@STRIP@
 PACKLD=@PACKLD@$(EMPTY)
 CCOMPTYPE=@ccomptype@
 TOOLCHAIN=@toolchain@
diff --git a/configure b/configure
index d95617e269d68bf4d86876852247ab541de1f81a..97aad962d1af69e461c0a66ec81924799ef71a05 100755
GIT binary patch
delta 67
zcmZp>tl559b3=pw<~IM;jI6;SL7oB427%iR0vT=9+jA-yftU%1nSq!Eh*^P{4T#x+
Mm}7fR1*g<U0B+hD8~^|S

delta 67
zcmZp_tl4&1b3=naYj8-AXTauq|22%whJo7+0~u}9+w&?IftU%1nSq!Eh*^P{4T#x+
Mm}7fh1*hak0BQ{xC;$Ke

diff --git a/configure.ac b/configure.ac
index 9ade5eff47..10df138754 100644
--- a/configure.ac
+++ b/configure.ac
@@ -243,6 +243,7 @@ AC_SUBST([mkdll_ldflags_exp])
 AC_SUBST([mkexe_ldflags_exp])
 AC_SUBST([PACKLD])
 AC_SUBST([build_libraries_manpages])
+AC_SUBST([STRIP])
 AC_SUBST([compute_deps])
 AC_SUBST([ocaml_bindir])
 AC_SUBST([ocaml_libdir])
diff --git a/stdlib/Makefile b/stdlib/Makefile
index 50f825a1b3..a7f2e60a7a 100644
--- a/stdlib/Makefile
+++ b/stdlib/Makefile
@@ -96,10 +96,7 @@ endif
 .INTERMEDIATE: tmpheader.exe
 tmpheader.exe: $(HEADERPROGRAM).$(O)
 	$(V_MKEXE)$(call MKEXE_VIA_CC,$@,$^)
-# FIXME This is wrong - mingw could invoke strip; MSVC equivalent?
-ifneq "$(UNIX_OR_WIN32)" "win32"
-	strip $@
-endif
+	$(STRIP) $@
 
 stdlib.cma: $(OBJS)
 	$(V_LINKC)$(CAMLC) -a -o $@ $^
-- 
2.43.0

